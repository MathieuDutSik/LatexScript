#!/usr/bin/perl -w


$uu=scalar(@ARGV);

if ($uu ne 1)
{
    print "LATEX_CheckCitation [TexFile]\n";
    print "with [TexFile] being a tex file\n";
    print "\n";
    print "it checks all citations and:\n";
    print "--Check for bibliographical reference of same name\n";
    print "--Check for unused bibliographical references\n";
    print "--Check for overload of reference\n";
    print "--Return statistical information for correct references\n";
    print "\n";
    print "It handles file with input and %\n";
    print "Limitations: you have to use \\cite{...} or \\citep{....}\n";
    print "and no mixture of the two is allowed\n";
    die;
}


sub MySplit($$)
{
    my ($str1, $str2)=@_;
    @RES=();
    @SPL1=split("", $str1);
    $nbChar1=scalar(@SPL1);
    @SPL2=split("", $str2);
    $nbChar2=scalar(@SPL2);
    print "nbChar1=".$nbChar1."  nbChar2=".$nbChar2."\n";
    $str="";
    $nbChar=0;
    $FirstMatch=0;
    for ($iChar=1; $iChar<=$nbChar2+1-$nbChar1; $iChar++)
    {
	$test=1;
	for ($iC=1; $iC<=$nbChar1; $iC++)
	{
	    if ($SPL2[$iChar+$iC-2] ne $SPL1[$iC-1])
	    {
		$test=0;
	    }
	}
	if ($test == 1 && $iChar == 1)
	{
	    $FirstMatch=1;
	}
	if ($test == 0)
	{
	    $str=$str.$SPL2[$iChar-1];
	    $nbChar++;
	}
	if ($test == 1)
	{
	    $RES[scalar(@RES)]=$str;
	    $str="";
	    $nbChar=0;
	}
    }
    for ($iChar=$nbChar2+2-$nbChar1; $iChar<=$nbChar2; $iChar++)
    {
	$eCharTest=$SPL2[$iChar-1];
	$str=$str.$SPL2[$iChar-1];
	print "iChar=".$iChar."  eChar=".$eCharTest."\n";
	$nbChar++;
    }
    $RES[scalar(@RES)]=$str;
    @RES2=();
    if ($FirstMatch == 1)
    {
	$RES2[0]=$RES[0];
	$iResBegin=2;
    }
    else
    {
	$iResBegin=1;
    }
    for ($iRes=$iResBegin; $iRes<=scalar(@RES); $iRes++)
    {
	$strRed="";
	@VSRRED=split("", $RES[$iRes-1]);
	$nbCharRed=0;
	for ($iChar=$nbChar1; $iChar<=scalar(@VSRRED); $iChar++)
	{
	    $strRed=$strRed.$VSRRED[$iChar-1];
	    $nbCharRed++;
	}
	print "nbCharRed=".$nbCharRed."  strRed=".$strRed."\n";
	if ($nbCharRed > 0)
	{
	    $RES2[scalar(@RES2)]=$strRed;
	}
    }
    @RES2;
}
# There is still work to be done to have the MySplit working correctly
# need to work on that.



sub ExtractFromInputLine($)
{
    my ($TheLine)=@_;
    $strSPKbis="\\";
    $strSPKbis=$strSPKbis."input";
    @V2=split($strSPKbis, $TheLine);
    if ($V2[0] ne "\\")
    {
	return "Z6PO_WVJJFHHNSD";
#	print "LINE=".$TheLine;
#	print "You break the rule on the inputs\n";
#	die;
    }
    @V3=split("}", $V2[1]);
    $_=$V3[0];
    s/ //;
    s/{//;
    s/\n//;
    return $_
}



#@VSL=MySplit("rr", "hjh9_rr_JJ_rr_hRRjkl_rrRR");
#@VSL=MySplit("rr", "hjh9_rr_JJJ_rr_HJK9");
#@VSL=MySplit("\\input", "hjh9_\\inputRR");
#for ($iCase=1; $iCase<=scalar(@VSL); $iCase++)
#{
#    print "iCase=".$iCase."  str=".$VSL[$iCase-1]."\n";
#}
#die;



sub ExtractFileNameFromLine($)
{
    my ($line)=@_;
    $_=$line;
    s/\n//;
    $line=$_;
    @V=split("input", $line);
    if (scalar(@V) >2)
    {
	print "You broke the assumption of only one file per line\n";
	die;
    }
    if (scalar(@V) > 1)
    {
#	print "V[0]=".$V[0]."\n";
#	print "V[1]=".$V[1]."\n";
	$file=ExtractFromInputLine($line);
	return $file;
    }
    return "Z6PO_WVJJFHHNSD";
}


sub PercentSplitting($)
{
    my ($strToSplit) = @_;
    @U=split("%", $strToSplit);
    $retPercentSplit=$U[0];
    for ($idxSplit=1; $idxSplit<=scalar(@U)-1; $idxSplit++)
    {
	@Lsplit=split("", $U[$idxSplit-1]);
	$len=scalar(@Lsplit);
	if ($len > 0 && $Lsplit[$len-1] ne "\\")
	{
	    $retPercentSplit=$retPercentSplit."%".$U[$idxSplit];
	}
	else
	{
	    return $retPercentSplit;
	}
    }
#    print "eLine=".$strToSplit."\n";
#    print "retLine=".$retPercentSplit."\n";
    return $retPercentSplit;
}


sub ListCall($)
{
    my ($FileName)=@_;
    my @MatchedSymbol=();
    open(INFILE, $FileName) or die "impossible to open ".$FileName;
    @B=<INFILE>;
    close(INFILE);
    for ($iLine=1; $iLine<=scalar(@B); $iLine++)
    {
	$line=$B[$iLine-1];
	$eLinePercSplit=PercentSplitting($line);
	$file=ExtractFileNameFromLine($eLinePercSplit);
	if ($file ne "Z6PO_WVJJFHHNSD")
	{
	    $MatchedSymbol[scalar(@MatchedSymbol)]=$file;
	}
    }
    @MatchedSymbol;
}

sub GetTheSuffix($)
{
    my ($TheLine)=@_;
    @V2=split("", $TheLine);
    @ListIndices=();
    for ($iChar=1; $iChar<=scalar(@V2); $iChar++)
    {
	if ($V2[$iChar-1] eq ".")
	{
	    $ListIndices[scalar(@ListIndices)]=$iChar;
	}
    }
    if (scalar(@ListIndices) eq 0)
    {
	$LimitChar=scalar(@V2)+1;
    }
    else
    {
	$LimitChar=$ListIndices[scalar(@ListIndices)-1]+1;
    }
    $suffix="";
    for ($iChar=$LimitChar; $iChar<=scalar(@V2); $iChar++)
    {
	$suffix=$suffix.$V2[$iChar-1];
    }
    return $suffix;
}



sub GetThePrefix($)
{
    my ($TheLine)=@_;
    @V2=split("", $TheLine);
    @ListIndices=();
    for ($iChar=1; $iChar<=scalar(@V2); $iChar++)
    {
	if ($V2[$iChar-1] eq ".")
	{
	    $ListIndices[scalar(@ListIndices)]=$iChar;
	}
    }
    if (scalar(@ListIndices) eq 0)
    {
	$LimitChar=scalar(@V2)+1;
    }
    else
    {
	$LimitChar=$ListIndices[scalar(@ListIndices)-1]-1;
    }
    $prefix="";
    for ($iChar=1; $iChar<=$LimitChar; $iChar++)
    {
	$prefix=$prefix.$V2[$iChar-1];
    }
    return $prefix;
}

sub ShallFileBeOpenedAtAll($)
{
    my ($TheLine)=@_;
    $suffix=GetTheSuffix($TheLine);
    if ($suffix eq "")
    {
	return 0;
    }
    if ($suffix eq "tex" || $suffix eq "latex" || $suffix eq "pdf_t" || $suffix eq "pstex_t")
    {
	return 1;
    }
    if ($suffix eq "sty")
    {
	return 0;
    }
    if ($suffix eq "pstex" || $suffix eq "ps" || $suffix eq "pdf" || $suffix eq "eps")
    {
	return 0;
    }
    return 0;
}


@ListFileNames=();
@Openable=();
@ListFileStatus=();
sub FuncInsertInDatabase($)
{
    my ($FileName)=@_;
    for ($kFile=1; $kFile<=scalar(@ListFileNames); $kFile++)
    {
	if ($ListFileNames[$kFile-1] eq $FileName)
	{
	    return;
	}
    }
    open(INFILE, $FileName) or die "impossible to open ".$FileName;
    close(INFILE);
    $insertVal=scalar(@ListFileNames);
    $ListFileNames[$insertVal]=$FileName;
    $ListFileStatus[$insertVal]=0;
    $Openable[$insertVal]=ShallFileBeOpenedAtAll($FileName);
}



for ($i=1; $i<=scalar(@ARGV); $i++)
{
    $NewFile=$ARGV[$i-1];
    FuncInsertInDatabase($NewFile);
}


while(1)
{
    $nbEntry=scalar(@ListFileNames);
    $IsFinished=1;
    for ($iFile=1; $iFile<=$nbEntry; $iFile++)
    {
	$FileName=$ListFileNames[$iFile-1];
	$test=$Openable[$iFile-1];
	if ($ListFileStatus[$iFile-1] eq 0)
	{
	    $ListFileStatus[$iFile-1]=1;
	    $IsFinished=0;
	    if ($test eq 1)
	    {
		@VSYMB=ListCall($FileName);
		for ($iSymb=1; $iSymb<=scalar(@VSYMB); $iSymb++)
		{
		    $NewFile=$VSYMB[$iSymb-1];
		    FuncInsertInDatabase($NewFile);
		}
	    }
	}
    }
    if ($IsFinished eq 1)
    {
	last;
    }
}



@LISTREF=();
@NumberDEF=();
@NumberCIT=();
@PositionBIBITEM=();
@PositionCITE=();
$idxCite=0;
$idxBibitem=0;
sub FuncInsertRef($$)
{
    my ($TheWorkCit, $status) = @_;
    for ($jCit=1; $jCit<=scalar(@LISTREF); $jCit++)
    {
	if ($LISTREF[$jCit-1] eq $TheWorkCit)
	{
	    if ($status eq "cite")
	    {
		if ($NumberCIT[$jCit-1] == 0)
		{
		    $idxCite++;
		    $PositionCITE[$jCit-1]=$idxCite;
		}
		$NumberCIT[$jCit-1]++;
	    }
	    if ($status eq "bibitem")
	    {
		if ($NumberDEF[$jCit-1] == 0)
		{
		    $idxBibitem++;
		    $PositionBIBITEM[$jCit-1]=$idxBibitem;
		}
		$NumberDEF[$jCit-1]++;
	    }
	    return;
	}
    }
    $insertVal=scalar(@LISTREF);
    $LISTREF[$insertVal]=$TheWorkCit;
    if ($status eq "cite")
    {
	$NumberCIT[$insertVal]=1;
	$NumberDEF[$insertVal]=0;
	$idxCite++;
	$PositionCITE[$insertVal]=$idxCite;
	$PositionBIBITEM[$insertVal]=-1;
    }
    if ($status eq "bibitem")
    {
	$NumberCIT[$insertVal]=0;
	$NumberDEF[$insertVal]=1;
	$idxBibitem++;
	$PositionCITE[$insertVal]=-1;
	$PositionBIBITEM[$insertVal]=$idxBibitem;
    }
}


sub FuncReadLineAndInsert($)
{
    my ($TheString) = @_;
    @L1=split("citep", $TheString);
    @L2=();
    for ($i1=1; $i1<=scalar(@L1); $i1++)
    {
	@CE=split("citet", $L1[$i1-1]);
	for ($iCE=1; $iCE<=scalar(@CE); $iCE++)
	{
	    $L2[scalar(@L2)]=$CE[$iCE-1];
	}
    }
    @L3=();
    for ($i2=1; $i2<=scalar(@L2); $i2++)
    {
	@CE=split("cite", $L2[$i2-1]);
	for ($iCE=1; $iCE<=scalar(@CE); $iCE++)
	{
	    $L3[scalar(@L3)]=$CE[$iCE-1];
	}
    }
    for ($iL=2; $iL<=scalar(@L3); $iL++)
    {
	$PrevPart=$L3[$iL-2];
	@VCL=split("", $PrevPart);
	if ($VCL[scalar(@VCL)-1] eq "\\")
	{
	    $ePart=$L3[$iL-1];
	    @VCL3=split("{", $ePart);
	    $RelPart=$VCL3[1];
	    @SL=split("}", $RelPart);
	    $TheCit=$SL[0];
	    @ListCits=split(",", $TheCit);
	    for ($iCit=1; $iCit<=scalar(@ListCits); $iCit++)
	    {
		$RealCit=$ListCits[$iCit-1];
		@VE=split("", $RealCit);
		for ($iChar=1; $iChar<=scalar(@VE); $iChar++)
		{
		    $eChar=$VE[$iChar-1];
		    if ($eChar eq " ")
		    {
			print "The citation \\cite{".$TheCit."} is incorrect\n";
			die;
		    }
		}
		FuncInsertRef($RealCit, "cite");
	    }
	}
    }
}

for ($iFile=1; $iFile<=$nbEntry; $iFile++)
{
    $FileName=$ListFileNames[$iFile-1];
    $test=$Openable[$iFile-1];
    if ($test eq 1)
    {
	open(INFILE, $FileName);
#	print "open FileName=".$FileName."\n";
	while(<INFILE>)
	{
	    $eLine=$_;
	    $strSplPerc=PercentSplitting($eLine);
	    FuncReadLineAndInsert($strSplPerc);
	    @L2=split("bibitem", $strSplPerc);
	    if (scalar(@L2) eq 2)
	    {
		@V1=split("\]", $L2[1]);
		if (scalar(@V1) eq 2)
		{
		    @V2=split("{", $V1[1]);
		    @V3=split("}", $V2[1]);
		    FuncInsertRef($V3[0], "bibitem");
		}
		else
		{
		    @V2=split("{", $L2[1]);
		    @V3=split("}", $V2[1]);
		    FuncInsertRef($V3[0], "bibitem");
		}
	    }
	}
	close(INFILE);
    }
}

@CorrectREF=();
@CorrectNB=();
for ($iCit=1; $iCit<=scalar(@LISTREF); $iCit++)
{
    $TheCit=$LISTREF[$iCit-1];
    $nbCIT=$NumberCIT[$iCit-1];
    $nbDEF=$NumberDEF[$iCit-1];
    if ($nbDEF eq 1 && $nbCIT > 0)
    {
	$CorrectREF[scalar(@CorrectREF)]=$TheCit;
	$CorrectNB[scalar(@CorrectNB)]=$nbCIT;
    }
}

for ($iCit=1; $iCit<=scalar(@CorrectREF)-1; $iCit++)
{
    for ($jCit=$iCit+1; $jCit<=scalar(@CorrectREF); $jCit++)
    {
	if ($CorrectNB[$iCit-1] < $CorrectNB[$jCit-1])
	{
	    $TheCit=$CorrectREF[$iCit-1];
	    $nbCIT=$CorrectNB[$iCit-1];
	    #
	    $CorrectREF[$iCit-1]=$CorrectREF[$jCit-1];
	    $CorrectNB[$iCit-1]=$CorrectNB[$jCit-1];
	    #
	    $CorrectREF[$jCit-1]=$TheCit;
	    $CorrectNB[$jCit-1]=$nbCIT;
	}
    }
}

print "Statistics of correct references\n";
for ($iCit=1; $iCit<=scalar(@CorrectREF)-1; $iCit++)
{
    print "Reference ".$CorrectREF[$iCit-1]." is cited ".$CorrectNB[$iCit-1]." times\n";
}


print "\n";
if (scalar(@CorrectREF) eq scalar(@LISTREF))
{
    print "All reference seems to be ok\n";
}
else
{
    print "Incorrect references\n";
    for ($iCit=1; $iCit<=scalar(@LISTREF); $iCit++)
    {
	$TheCit=$LISTREF[$iCit-1];
	$nbCIT=$NumberCIT[$iCit-1];
	$nbDEF=$NumberDEF[$iCit-1];
	if ($nbCIT eq 0)
	{
	    print "Reference ".$TheCit." is not cited\n";
	}
	if ($nbDEF eq 0)
	{
	    print "Reference ".$TheCit." is not defined in the bibliography\n";
	}
	if ($nbDEF > 1)
	{
	    print "Reference ".$TheCit." is defined several times in the bibliography\n";
	}
    }
}
if (scalar(@CorrectREF) eq scalar(@LISTREF))
{
    for ($iCit=1; $iCit<=scalar(@LISTREF); $iCit++)
    {
	$TheCit=$LISTREF[$iCit-1];
	$pos1=$PositionCITE[$iCit-1];
	$pos2=$PositionBIBITEM[$iCit-1];
	if ($pos1 ne $pos2)
	{
	    print "Citation ".$TheCit." CiteRank=".$pos1." BibitemRank=".$pos2."\n";
	}
    }


}

print "NOTE: this program complements latex reference system.\n";
print "it does not dispense from reading the .log file\n";
